(()=>{var j="parallelismus";var C=(function(){try{if(window.__PARALLELISMUS_BASE__)return window.__PARALLELISMUS_BASE__;if(document.currentScript&&document.currentScript.src)return new URL("./",document.currentScript.src).href}catch{}return""})(),v=C+"data/bible.json",d=null,_=null;function R(){return new Promise((e,r)=>{let o=indexedDB.open(j,1);o.onupgradeneeded=s=>{let t=s.target.result;if(t.objectStoreNames.contains("books")||t.createObjectStore("books",{keyPath:"id"}),t.objectStoreNames.contains("chapters")||t.createObjectStore("chapters",{keyPath:"id"}).createIndex("book_id","book_id",{unique:!1}),t.objectStoreNames.contains("verses")||t.createObjectStore("verses",{keyPath:"id"}).createIndex("chapter_id","chapter_id",{unique:!1}),!t.objectStoreNames.contains("verseWords")){let a=t.createObjectStore("verseWords",{keyPath:"id"});a.createIndex("verse_id","verse_id",{unique:!1}),a.createIndex("word_id","word_id",{unique:!1})}if(t.objectStoreNames.contains("words")||t.createObjectStore("words",{keyPath:"strong"}),!t.objectStoreNames.contains("relations")){let a=t.createObjectStore("relations",{keyPath:"id",autoIncrement:!0});a.createIndex("source_id","source_id",{unique:!1}),a.createIndex("target_id","target_id",{unique:!1})}},o.onsuccess=()=>e(o.result),o.onerror=()=>r(o.error)})}function p(e,r,o){return new Promise((s,t)=>{let a=e.transaction(r,"readwrite"),c=a.objectStore(r);for(let u of o)c.put(u);a.oncomplete=()=>s(),a.onerror=()=>t(a.error)})}function g(e,r){return new Promise((o,s)=>{let a=e.transaction(r,"readonly").objectStore(r).count();a.onsuccess=()=>o(a.result),a.onerror=()=>s(a.error)})}function I(e,r){return new Promise((o,s)=>{let t=e.transaction(r,"readwrite");t.objectStore(r).clear(),t.oncomplete=()=>o(),t.onerror=()=>s(t.error)})}async function L(e,r){let o=await g(e,"books"),s=await g(e,"verseWords"),t=await g(e,"words");if(o>0&&s>0&&t>0){r&&r("Database already loaded.");return}if(o>0||s>0||t>0){r&&r("Incomplete database detected, re-downloading\u2026");for(let i of["books","chapters","verses","words","verseWords"])await I(e,i)}r&&r("Downloading bible data\u2026");let a=await fetch(v);if(!a.ok)throw new Error(`Failed to fetch ${v}: ${a.status}`);let c=await a.json();r&&r("Loading books\u2026"),await p(e,"books",c.books),r&&r("Loading chapters\u2026"),await p(e,"chapters",c.chapters),r&&r("Loading verses\u2026"),await p(e,"verses",c.verses),r&&r("Loading words\u2026"),await p(e,"words",c.words),r&&r("Loading verse-words (this may take a moment)\u2026");let u=c.verseWords,n=2e4;for(let i=0;i<u.length;i+=n)await p(e,"verseWords",u.slice(i,i+n)),r&&r(`Loading verse-words\u2026 ${Math.min(i+n,u.length)}/${u.length}`);r&&r("Database ready.")}async function b(e){return d||_||(_=(async()=>(d=await R(),await L(d,e),d))(),_)}function N(e){return new Promise((r,o)=>{let t=d.transaction(e,"readonly").objectStore(e).getAll();t.onsuccess=()=>r(t.result),t.onerror=()=>o(t.error)})}async function m(e=500,r=null){let o=await N("relations");r&&(o=o.filter(n=>n.relation_type===r)),e&&(o=o.slice(0,e));let s=new Set;for(let n of o)n.source_id&&s.add(n.source_id),n.target_id&&s.add(n.target_id);let t={},c=d.transaction("words","readonly").objectStore("words");for(let n of s){let i=await new Promise((E,A)=>{let h=c.get(n);h.onsuccess=()=>E(h.result),h.onerror=()=>A(h.error)});i&&(t[n]=i)}function u(n,i){return n?Array.isArray(n.translation)&&n.translation[0]?`${i} \u2014 ${n.translation[0]}`:Array.isArray(n.original)&&n.original[0]?`${i} \u2014 ${n.original[0]}`:i:i}return o.map(n=>({id:n.id,source_id:n.source_id,target_id:n.target_id,relation_type:n.relation_type,source_label:u(t[n.source_id],n.source_id||""),target_label:u(t[n.target_id],n.target_id||"")}))}var W=document.getElementById("relationType"),M=document.getElementById("limit"),B=document.getElementById("layout"),$=document.getElementById("refresh"),S=document.getElementById("graph-status"),q=document.getElementById("graph"),f=document.getElementById("loading-status"),l,D=["#38bdf8","#f472b6","#facc15","#4ade80","#a78bfa","#fb7185","#fbbf24","#34d399","#60a5fa"],w=new Map,y=(e,r=!1)=>{S.textContent=e,S.style.color=r?"#f87171":"#94a3b8"},z=e=>e?(w.has(e)||w.set(e,D[w.size%D.length]),w.get(e)):"#94a3b8",P=e=>{let r=[],o=[],s=new Map;return e.forEach(t=>{t.source_id&&!s.has(t.source_id)&&(s.set(t.source_id,!0),r.push({id:t.source_id,label:t.source_label||t.source_id,title:t.source_label||t.source_id,color:"#1d4ed8"})),t.target_id&&!s.has(t.target_id)&&(s.set(t.target_id,!0),r.push({id:t.target_id,label:t.target_label||t.target_id,title:t.target_label||t.target_id,color:"#9333ea"})),o.push({id:`edge-${t.id}`,from:t.source_id,to:t.target_id,label:t.relation_type||"relation",color:{color:z(t.relation_type),opacity:.7},font:{align:"horizontal",size:12,color:"#cbd5f5"},arrows:{to:{enabled:!0,scaleFactor:.6}},smooth:{enabled:!0,type:"dynamic"}})}),{nodes:r,edges:o}},F=e=>{let r=e.length||1,o=Math.max(220,r*10);return e.map((s,t)=>{let a=2*Math.PI*t/r;return{...s,x:o*Math.cos(a),y:o*Math.sin(a),fixed:!0}})},T=e=>e==="circular"?{layout:{improvedLayout:!1},physics:{enabled:!1}}:e==="kamada_kawai"?{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{fit:!0,iterations:200}}}:{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"barnesHut",stabilization:{fit:!0,iterations:200}}},x=e=>{let r=B.value,o=T(r),s=r==="circular"?F(e.nodes):e.nodes,t={nodes:new vis.DataSet(s),edges:new vis.DataSet(e.edges)};l?(l.setOptions(o),l.setData(t)):l=new vis.Network(q,t,o),l.fit()},k=async()=>{y("Loading graph\u2026");try{let e=parseInt(M.value,10)||500,r=W.value.trim()||null,o=await m(e,r);if(!Array.isArray(o)||o.length===0){y("No relations found for this filter."),x({nodes:[],edges:[]});return}let s=P(o);x(s),y(`Rendered ${s.nodes.length} nodes and ${s.edges.length} edges.`)}catch(e){console.error(e),y(`Failed to load graph: ${e.message}`,!0)}};(async()=>{try{await b(e=>{f&&(f.textContent=e)}),f&&(f.style.display="none"),await k()}catch(e){f&&(f.textContent="DB init failed: "+String(e))}})();$.addEventListener("click",()=>k());B.addEventListener("change",()=>{if(!l)return;let e=l.body.data.nodes.get(),r=l.body.data.edges.get();x({nodes:e,edges:r})});})();
