(()=>{var S=(function(){try{if(window.__PARALLELISMUS_BASE__)return window.__PARALLELISMUS_BASE__;if(document.currentScript&&document.currentScript.src)return new URL("./",document.currentScript.src).href}catch{}return""})(),y=S+"data/bible-index.json";var A=[],w=[],b=[],p={},c={},u={},m={};var R="parallelismus",k=2,x=null;function C(){return new Promise((e,n)=>{let o=indexedDB.open(R,k);o.onupgradeneeded=r=>{let t=r.target.result;for(let s of["books","chapters","verses","verseWords","words"])t.objectStoreNames.contains(s)&&t.deleteObjectStore(s);if(!t.objectStoreNames.contains("relations")){let s=t.createObjectStore("relations",{keyPath:"id",autoIncrement:!0});s.createIndex("source_id","source_id",{unique:!1}),s.createIndex("target_id","target_id",{unique:!1})}},o.onsuccess=()=>e(o.result),o.onerror=()=>n(o.error)})}var l=null;async function h(e){return l||(l=(async()=>{e&&e("Loading bible index\u2026");let n=await fetch(y);if(!n.ok)throw new Error(`Failed to fetch ${y}: ${n.status}`);let o=await n.json();A=o.books,w=o.chapters,b=o.verses,p={};for(let r of o.words)p[r.strong]=r;c={};for(let r of w)c[r.book_id]||(c[r.book_id]=[]),c[r.book_id].push(r);u={},m={};for(let r of b)u[r.chapter_id]||(u[r.chapter_id]=[]),u[r.chapter_id].push(r),m[r.id]=r.chapter_id;x=await C(),e&&e("Ready.")})(),l)}function L(){return new Promise((e,n)=>{let r=x.transaction("relations","readonly").objectStore("relations").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>n(r.error)})}async function _(e=500,n=null){let o=await L();n&&(o=o.filter(t=>t.relation_type===n)),e&&(o=o.slice(0,e));function r(t){let s=p[t];return s?Array.isArray(s.translation)&&s.translation[0]?`${t} \u2014 ${s.translation[0]}`:Array.isArray(s.original)&&s.original[0]?`${t} \u2014 ${s.original[0]}`:t||"":t||""}return o.map(t=>({id:t.id,source_id:t.source_id,target_id:t.target_id,relation_type:t.relation_type,source_label:r(t.source_id),target_label:r(t.target_id)}))}var j=document.getElementById("relationType"),$=document.getElementById("limit"),E=document.getElementById("layout"),I=document.getElementById("refresh"),v=document.getElementById("graph-status"),O=document.getElementById("graph"),i=document.getElementById("loading-status"),a,D=["#38bdf8","#f472b6","#facc15","#4ade80","#a78bfa","#fb7185","#fbbf24","#34d399","#60a5fa"],d=new Map,f=(e,n=!1)=>{v.textContent=e,v.style.color=n?"#f87171":"#94a3b8"},P=e=>e?(d.has(e)||d.set(e,D[d.size%D.length]),d.get(e)):"#94a3b8",z=e=>{let n=[],o=[],r=new Map;return e.forEach(t=>{t.source_id&&!r.has(t.source_id)&&(r.set(t.source_id,!0),n.push({id:t.source_id,label:t.source_label||t.source_id,title:t.source_label||t.source_id,color:"#1d4ed8"})),t.target_id&&!r.has(t.target_id)&&(r.set(t.target_id,!0),n.push({id:t.target_id,label:t.target_label||t.target_id,title:t.target_label||t.target_id,color:"#9333ea"})),o.push({id:`edge-${t.id}`,from:t.source_id,to:t.target_id,label:t.relation_type||"relation",color:{color:P(t.relation_type),opacity:.7},font:{align:"horizontal",size:12,color:"#cbd5f5"},arrows:{to:{enabled:!0,scaleFactor:.6}},smooth:{enabled:!0,type:"dynamic"}})}),{nodes:n,edges:o}},F=e=>{let n=e.length||1,o=Math.max(220,n*10);return e.map((r,t)=>{let s=2*Math.PI*t/n;return{...r,x:o*Math.cos(s),y:o*Math.sin(s),fixed:!0}})},M=e=>e==="circular"?{layout:{improvedLayout:!1},physics:{enabled:!1}}:e==="kamada_kawai"?{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{fit:!0,iterations:200}}}:{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"barnesHut",stabilization:{fit:!0,iterations:200}}},g=e=>{let n=E.value,o=M(n),r=n==="circular"?F(e.nodes):e.nodes,t={nodes:new vis.DataSet(r),edges:new vis.DataSet(e.edges)};a?(a.setOptions(o),a.setData(t)):a=new vis.Network(O,t,o),a.fit()},B=async()=>{f("Loading graph\u2026");try{let e=parseInt($.value,10)||500,n=j.value.trim()||null,o=await _(e,n);if(!Array.isArray(o)||o.length===0){f("No relations found for this filter."),g({nodes:[],edges:[]});return}let r=z(o);g(r),f(`Rendered ${r.nodes.length} nodes and ${r.edges.length} edges.`)}catch(e){console.error(e),f(`Failed to load graph: ${e.message}`,!0)}};(async()=>{try{await h(e=>{i&&(i.textContent=e)}),i&&(i.style.display="none"),await B()}catch(e){i&&(i.textContent="DB init failed: "+String(e))}})();I.addEventListener("click",()=>B());E.addEventListener("change",()=>{if(!a)return;let e=a.body.data.nodes.get(),n=a.body.data.edges.get();g({nodes:e,edges:n})});})();
