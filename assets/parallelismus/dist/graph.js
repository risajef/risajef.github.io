(()=>{var A="parallelismus";var R=(function(){try{if(window.__PARALLELISMUS_BASE__)return window.__PARALLELISMUS_BASE__;if(document.currentScript&&document.currentScript.src)return new URL("./",document.currentScript.src).href}catch{}return""})(),x=R+"data/bible.json",d=null,_=null;function j(){return new Promise((e,r)=>{let o=indexedDB.open(A,1);o.onupgradeneeded=n=>{let t=n.target.result;if(t.objectStoreNames.contains("books")||t.createObjectStore("books",{keyPath:"id"}),t.objectStoreNames.contains("chapters")||t.createObjectStore("chapters",{keyPath:"id"}).createIndex("book_id","book_id",{unique:!1}),t.objectStoreNames.contains("verses")||t.createObjectStore("verses",{keyPath:"id"}).createIndex("chapter_id","chapter_id",{unique:!1}),!t.objectStoreNames.contains("verseWords")){let s=t.createObjectStore("verseWords",{keyPath:"id"});s.createIndex("verse_id","verse_id",{unique:!1}),s.createIndex("word_id","word_id",{unique:!1})}if(t.objectStoreNames.contains("words")||t.createObjectStore("words",{keyPath:"strong"}),!t.objectStoreNames.contains("relations")){let s=t.createObjectStore("relations",{keyPath:"id",autoIncrement:!0});s.createIndex("source_id","source_id",{unique:!1}),s.createIndex("target_id","target_id",{unique:!1})}},o.onsuccess=()=>e(o.result),o.onerror=()=>r(o.error)})}function p(e,r,o){return new Promise((n,t)=>{let s=e.transaction(r,"readwrite"),u=s.objectStore(r);for(let i of o)u.put(i);s.oncomplete=()=>n(),s.onerror=()=>t(s.error)})}function C(e,r){return new Promise((o,n)=>{let s=e.transaction(r,"readonly").objectStore(r).count();s.onsuccess=()=>o(s.result),s.onerror=()=>n(s.error)})}async function L(e,r){if(await C(e,"books")>0){r&&r("Database already loaded.");return}r&&r("Downloading bible data\u2026");let n=await fetch(x);if(!n.ok)throw new Error(`Failed to fetch ${x}: ${n.status}`);let t=await n.json();r&&r("Loading books\u2026"),await p(e,"books",t.books),r&&r("Loading chapters\u2026"),await p(e,"chapters",t.chapters),r&&r("Loading verses\u2026"),await p(e,"verses",t.verses),r&&r("Loading words\u2026"),await p(e,"words",t.words),r&&r("Loading verse-words (this may take a moment)\u2026");let s=t.verseWords,u=2e4;for(let i=0;i<s.length;i+=u)await p(e,"verseWords",s.slice(i,i+u)),r&&r(`Loading verse-words\u2026 ${Math.min(i+u,s.length)}/${s.length}`);r&&r("Database ready.")}async function g(e){return d||_||(_=(async()=>(d=await j(),await L(d,e),d))(),_)}function I(e){return new Promise((r,o)=>{let t=d.transaction(e,"readonly").objectStore(e).getAll();t.onsuccess=()=>r(t.result),t.onerror=()=>o(t.error)})}async function b(e=500,r=null){let o=await I("relations");r&&(o=o.filter(a=>a.relation_type===r)),e&&(o=o.slice(0,e));let n=new Set;for(let a of o)a.source_id&&n.add(a.source_id),a.target_id&&n.add(a.target_id);let t={},u=d.transaction("words","readonly").objectStore("words");for(let a of n){let l=await new Promise((k,E)=>{let h=u.get(a);h.onsuccess=()=>k(h.result),h.onerror=()=>E(h.error)});l&&(t[a]=l)}function i(a,l){return a?Array.isArray(a.translation)&&a.translation[0]?`${l} \u2014 ${a.translation[0]}`:Array.isArray(a.original)&&a.original[0]?`${l} \u2014 ${a.original[0]}`:l:l}return o.map(a=>({id:a.id,source_id:a.source_id,target_id:a.target_id,relation_type:a.relation_type,source_label:i(t[a.source_id],a.source_id||""),target_label:i(t[a.target_id],a.target_id||"")}))}var O=document.getElementById("relationType"),W=document.getElementById("limit"),D=document.getElementById("layout"),M=document.getElementById("refresh"),v=document.getElementById("graph-status"),$=document.getElementById("graph"),f=document.getElementById("loading-status"),c,S=["#38bdf8","#f472b6","#facc15","#4ade80","#a78bfa","#fb7185","#fbbf24","#34d399","#60a5fa"],w=new Map,y=(e,r=!1)=>{v.textContent=e,v.style.color=r?"#f87171":"#94a3b8"},q=e=>e?(w.has(e)||w.set(e,S[w.size%S.length]),w.get(e)):"#94a3b8",P=e=>{let r=[],o=[],n=new Map;return e.forEach(t=>{t.source_id&&!n.has(t.source_id)&&(n.set(t.source_id,!0),r.push({id:t.source_id,label:t.source_label||t.source_id,title:t.source_label||t.source_id,color:"#1d4ed8"})),t.target_id&&!n.has(t.target_id)&&(n.set(t.target_id,!0),r.push({id:t.target_id,label:t.target_label||t.target_id,title:t.target_label||t.target_id,color:"#9333ea"})),o.push({id:`edge-${t.id}`,from:t.source_id,to:t.target_id,label:t.relation_type||"relation",color:{color:q(t.relation_type),opacity:.7},font:{align:"horizontal",size:12,color:"#cbd5f5"},arrows:{to:{enabled:!0,scaleFactor:.6}},smooth:{enabled:!0,type:"dynamic"}})}),{nodes:r,edges:o}},z=e=>{let r=e.length||1,o=Math.max(220,r*10);return e.map((n,t)=>{let s=2*Math.PI*t/r;return{...n,x:o*Math.cos(s),y:o*Math.sin(s),fixed:!0}})},F=e=>e==="circular"?{layout:{improvedLayout:!1},physics:{enabled:!1}}:e==="kamada_kawai"?{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{fit:!0,iterations:200}}}:{layout:{improvedLayout:!0},physics:{enabled:!0,solver:"barnesHut",stabilization:{fit:!0,iterations:200}}},m=e=>{let r=D.value,o=F(r),n=r==="circular"?z(e.nodes):e.nodes,t={nodes:new vis.DataSet(n),edges:new vis.DataSet(e.edges)};c?(c.setOptions(o),c.setData(t)):c=new vis.Network($,t,o),c.fit()},B=async()=>{y("Loading graph\u2026");try{let e=parseInt(W.value,10)||500,r=O.value.trim()||null,o=await b(e,r);if(!Array.isArray(o)||o.length===0){y("No relations found for this filter."),m({nodes:[],edges:[]});return}let n=P(o);m(n),y(`Rendered ${n.nodes.length} nodes and ${n.edges.length} edges.`)}catch(e){console.error(e),y(`Failed to load graph: ${e.message}`,!0)}};(async()=>{try{await g(e=>{f&&(f.textContent=e)}),f&&(f.style.display="none"),await B()}catch(e){f&&(f.textContent="DB init failed: "+String(e))}})();M.addEventListener("click",()=>B());D.addEventListener("change",()=>{if(!c)return;let e=c.body.data.nodes.get(),r=c.body.data.edges.get();m({nodes:e,edges:r})});})();
