(()=>{var be="parallelismus";var _e=(function(){try{if(window.__PARALLELISMUS_BASE__)return window.__PARALLELISMUS_BASE__;if(document.currentScript&&document.currentScript.src)return new URL("./",document.currentScript.src).href}catch{}return""})(),ie=_e+"data/bible.json",p=null,D=null;function Ee(){return new Promise((e,t)=>{let r=indexedDB.open(be,1);r.onupgradeneeded=n=>{let o=n.target.result;if(o.objectStoreNames.contains("books")||o.createObjectStore("books",{keyPath:"id"}),o.objectStoreNames.contains("chapters")||o.createObjectStore("chapters",{keyPath:"id"}).createIndex("book_id","book_id",{unique:!1}),o.objectStoreNames.contains("verses")||o.createObjectStore("verses",{keyPath:"id"}).createIndex("chapter_id","chapter_id",{unique:!1}),!o.objectStoreNames.contains("verseWords")){let a=o.createObjectStore("verseWords",{keyPath:"id"});a.createIndex("verse_id","verse_id",{unique:!1}),a.createIndex("word_id","word_id",{unique:!1})}if(o.objectStoreNames.contains("words")||o.createObjectStore("words",{keyPath:"strong"}),!o.objectStoreNames.contains("relations")){let a=o.createObjectStore("relations",{keyPath:"id",autoIncrement:!0});a.createIndex("source_id","source_id",{unique:!1}),a.createIndex("target_id","target_id",{unique:!1})}},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}function C(e,t,r){return new Promise((n,o)=>{let a=e.transaction(t,"readwrite"),i=a.objectStore(t);for(let s of r)i.put(s);a.oncomplete=()=>n(),a.onerror=()=>o(a.error)})}function U(e,t){return new Promise((r,n)=>{let a=e.transaction(t,"readonly").objectStore(t).count();a.onsuccess=()=>r(a.result),a.onerror=()=>n(a.error)})}function xe(e,t){return new Promise((r,n)=>{let o=e.transaction(t,"readwrite");o.objectStore(t).clear(),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)})}async function Se(e,t){let r=await U(e,"books"),n=await U(e,"verseWords"),o=await U(e,"words");if(r>0&&n>0&&o>0){t&&t("Database already loaded.");return}if(r>0||n>0||o>0){t&&t("Incomplete database detected, re-downloading\u2026");for(let l of["books","chapters","verses","words","verseWords"])await xe(e,l)}t&&t("Downloading bible data\u2026");let a=await fetch(ie);if(!a.ok)throw new Error(`Failed to fetch ${ie}: ${a.status}`);let i=await a.json();t&&t("Loading books\u2026"),await C(e,"books",i.books),t&&t("Loading chapters\u2026"),await C(e,"chapters",i.chapters),t&&t("Loading verses\u2026"),await C(e,"verses",i.verses),t&&t("Loading words\u2026"),await C(e,"words",i.words),t&&t("Loading verse-words (this may take a moment)\u2026");let s=i.verseWords,c=2e4;for(let l=0;l<s.length;l+=c)await C(e,"verseWords",s.slice(l,l+c)),t&&t(`Loading verse-words\u2026 ${Math.min(l+c,s.length)}/${s.length}`);t&&t("Database ready.")}async function F(e){return p||D||(D=(async()=>(p=await Ee(),await Se(p,e),p))(),D)}function _(e){return new Promise((t,r)=>{let o=p.transaction(e,"readonly").objectStore(e).getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>r(o.error)})}function v(e,t){return new Promise((r,n)=>{let a=p.transaction(e,"readonly").objectStore(e).get(t);a.onsuccess=()=>r(a.result),a.onerror=()=>n(a.error)})}function j(e,t,r){return new Promise((n,o)=>{let s=p.transaction(e,"readonly").objectStore(e).index(t).getAll(r);s.onsuccess=()=>n(s.result),s.onerror=()=>o(s.error)})}async function L(){return _("books")}async function J(e){return j("chapters","book_id",Number(e))}async function z(e){return j("verses","chapter_id",Number(e))}async function T(e){let t=await j("verseWords","verse_id",Number(e)),r=[],o=p.transaction("words","readonly").objectStore("words");for(let a of t){let i=await new Promise((s,c)=>{let l=o.get(a.word_id);l.onsuccess=()=>s(l.result),l.onerror=()=>c(l.error)});r.push({strong:a.word_id,verse_original:a.original||"",verse_translation:a.translation||"",all_originals:i?i.original:[],all_translations:i?i.translation:[]})}return r}async function O(e){return v("verses",Number(e))}async function k(e){let t=await v("chapters",Number(e));if(!t)throw new Error("Chapter not found");return t}async function $(e){let t=await v("words",e);if(!t)throw new Error("Word not found");let r=await j("verseWords","word_id",e),n=[];for(let o of r){let a=await v("verses",o.verse_id);if(!a)continue;let i=await v("chapters",a.chapter_id);if(!i)continue;let s=await v("books",i.book_id);s&&n.push({verse_id:a.id,verse_number:a.number,chapter_id:i.id,chapter_number:i.number,book_id:s.id,book_name:s.name,verse_original:o.original||"",verse_translation:o.translation||""})}return{strong:t.strong,all_originals:t.original,all_translations:t.translation,usages:n}}async function G(e){return new Promise((t,r)=>{let o=p.transaction("relations","readwrite").objectStore("relations"),a={source_id:e.source_id,target_id:e.target_id,relation_type:e.relation_type,source_verse_id:e.source_verse_id||null,notes:e.notes||null},i=o.add(a);i.onsuccess=()=>{a.id=i.result,t(a)},i.onerror=()=>r(i.error)})}async function K(e){let t=await v("relations",Number(e));if(!t)throw new Error("Relation not found");return new Promise((r,n)=>{let o=p.transaction("relations","readwrite");o.objectStore("relations").delete(Number(e)),o.oncomplete=()=>r(t),o.onerror=()=>n(o.error)})}async function W(e){return(await _("relations")).filter(r=>r.source_id===e||r.target_id===e)}async function X(e){let t=await W(e),r={};for(let n of t){let o=`${n.source_id}|${n.target_id}|${n.relation_type}`;r[o]||(r[o]={source_id:n.source_id,target_id:n.target_id,relation_type:n.relation_type,source_verse_ids:new Set}),n.source_verse_id!=null&&r[o].source_verse_ids.add(n.source_verse_id)}return Object.values(r).map(n=>({...n,source_verse_ids:[...n.source_verse_ids].sort((o,a)=>o-a)}))}async function Y(e){if(!Array.isArray(e)||e.length===0)return{};let t=await _("relations"),r={};for(let n of e)r[n]=!1;for(let n of t)r.hasOwnProperty(n.source_id)&&(r[n.source_id]=!0),r.hasOwnProperty(n.target_id)&&(r[n.target_id]=!0);return r}async function Z(e){if(!Array.isArray(e)||e.length===0)return{};let t=await _("relations"),r={};for(let n of e)r[n]=0;for(let n of t)r.hasOwnProperty(n.source_id)&&r[n.source_id]++,r.hasOwnProperty(n.target_id)&&r[n.target_id]++;return r}async function Q(){let e=await _("relations"),t=new Set;for(let r of e)r.relation_type&&t.add(r.relation_type);return[...t].sort()}async function ee(){let e=await _("relations");return JSON.stringify(e,null,2)}async function te(e){let t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Expected an array of relation objects");return await new Promise((r,n)=>{let o=p.transaction("relations","readwrite");o.objectStore("relations").clear(),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)}),new Promise((r,n)=>{let o=p.transaction("relations","readwrite"),a=o.objectStore("relations");for(let i of t)a.put(i);o.oncomplete=()=>r(t.length),o.onerror=()=>n(o.error)})}function Ce(e){try{return e.normalize("NFD").replace(/\p{M}/gu,"")}catch{return e}}function se(e){if(!e)return"";let t=Ce(e.toLowerCase()),r={\u03B1:"a",\u03B2:"b",\u03B3:"g",\u03B4:"d",\u03B5:"e",\u03B6:"z",\u03B7:"e",\u03B8:"th",\u03B9:"i",\u03BA:"k",\u03BB:"l",\u03BC:"m",\u03BD:"n",\u03BE:"x",\u03BF:"o",\u03C0:"p",\u03C1:"r",\u03C3:"s",\u03C2:"s",\u03C4:"t",\u03C5:"u",\u03C6:"ph",\u03C7:"ch",\u03C8:"ps",\u03C9:"o"},n="";for(let o of t)n+=r[o]!==void 0?r[o]:/[a-z0-9]/.test(o)?o:"";return n=n.replace(/uu/g,"u").replace(/phh/g,"ph"),n}function ce(e){if(!e)return"";let t=e.normalize("NFD"),r={\u05D0:"",\u05D1:"b",\u05D2:"g",\u05D3:"d",\u05D4:"h",\u05D5:"v",\u05D6:"z",\u05D7:"ch",\u05D8:"t",\u05D9:"y",\u05DB:"k",\u05DA:"k",\u05DC:"l",\u05DE:"m",\u05DD:"m",\u05E0:"n",\u05E1:"s",\u05E2:"",\u05E3:"p",\u05E4:"p",\u05E5:"ts",\u05E6:"ts",\u05E7:"q",\u05E8:"r",\u05E9:"sh",\u05EA:"t"},n={"\u05B0":"e","\u05B1":"e","\u05B2":"a","\u05B3":"a","\u05B4":"i","\u05B5":"e","\u05B6":"e","\u05B7":"a","\u05B8":"a","\u05B9":"o","\u05BB":"u","\u05C7":"o"},o="\u05C1",a="\u05C2",i=[],s=-1;for(let l=0;l<t.length;l++){let d=t[l],u=d.codePointAt(0);if(u>=1488&&u<=1514){let S=r[d]!==void 0?r[d]:"";i.push(S),s=i.length-1;continue}if(n[d]){s>=0?i[s]=i[s]+n[d]:(i.push(n[d]),s=i.length-1);continue}if(d===a){s>=0&&i[s].endsWith("sh")&&(i[s]=i[s].slice(0,-2)+"s");continue}if(d===o){s>=0&&i[s].endsWith("s")&&(i[s]=i[s]+"h");continue}/[A-Za-z0-9]/.test(d)&&(i.push(d),s=i.length-1)}let c=i.join(" ").replace(/\s+/g," ").trim();return c=c.replace(/''/g,"'"),c.toLowerCase()}function le(e){if(!e)return"";try{if(/\p{Script=Greek}/u.test(e))return se(e);if(/\p{Script=Hebrew}/u.test(e))return ce(e)}catch{if(/[\u0370-\u03FF]/.test(e))return se(e);if(/[\u0590-\u05FF]/.test(e))return ce(e)}return""}function V(e){return e==null?"":String(e).replace(/[&<>\"]+/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return""}})}function ne(e,t){if(!Array.isArray(e))return[];let r=e.length;if(r<=t)return e.slice();let n=[],o=new Set;for(;n.length<t;){let a=Math.floor(Math.random()*r);o.has(a)||(o.add(a),n.push(e[a]))}return n}function de(e){let t=document.createElement("div");return t.id="word-tooltip",t.classList.add("static"),t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),e&&e.appendChild(t),{el:t,show(r){t.innerHTML=r||"",t.classList.add("show")},hide(){t.classList.remove("show")},append(r){t.innerHTML=(t.innerHTML||"")+r,t.classList.add("show")}}}function ue(e,t,r){let n=e.length?"<ul>"+e.map(a=>`<li>${r(a)}</li>`).join("")+"</ul>":"<div>-</div>",o=t.length?"<ul>"+t.map(a=>`<li>${r(a)}</li>`).join("")+"</ul>":"<div>-</div>";return`<div class="tooltip-grid"><div class="tooltip-col"><h4>Translations</h4>${n}</div><div class="tooltip-col"><h4>Originals</h4>${o}</div></div>`}function fe(){return'<div style="margin-top:6px;font-size:.9rem;color:var(--muted)"><strong>Keyboard</strong><ul style="margin:6px 0 0 1rem;padding:0"><li>Alt+S \u2014 focus Source input</li><li>Alt+T \u2014 focus Target input</li><li>Alt+R \u2014 focus Relation type</li><li>Alt+Enter \u2014 Add Relation</li></ul></div>'}function pe(e,t,r){let n=!1;e&&e.addEventListener("click",o=>{if(o.preventDefault(),n=!n,n){let a=r&&typeof r=="function"?r():t.buildShortcutHtml?t.buildShortcutHtml():"";t.append(a),e.setAttribute("aria-pressed","true")}else t.hide(),e.setAttribute("aria-pressed","false")}),document.addEventListener("keydown",o=>{if(!o.altKey)return;let a=o.key.toLowerCase();a==="s"?(o.preventDefault(),document.getElementById("src")?.focus()):a==="t"?(o.preventDefault(),document.getElementById("tgt")?.focus()):a==="r"?(o.preventDefault(),document.getElementById("type")?.focus()):o.key==="Enter"&&(o.preventDefault(),document.getElementById("addRel")?.click())})}var m=document.getElementById("books"),y=document.getElementById("chapters"),g=document.getElementById("verses"),H=document.getElementById("words"),f=document.getElementById("result"),me=document.getElementById("next-chapter"),he=document.getElementById("next-verse"),E=document.getElementById("loading-status"),w=[],h=[],ke=le;async function Be(){try{await F(e=>{E&&(E.textContent=e)}),E&&(E.style.display="none"),ye()}catch(e){console.error("DB init failed",e),E&&(E.textContent="Failed to initialise database: "+String(e)),f&&(f.textContent="Failed to initialise database: "+String(e))}}Be();function Ie(){return window.location.hash.replace(/^#/,"")||"/"}function x(e){history.pushState(null,"","#"+e)}function Ne(){let e=Ie().split("/").filter(Boolean),t={chapterId:null,verseId:null,bookId:null};return e.length>=2&&e[0]==="chapter"?t.chapterId=Number(e[1]):e.length>=2&&e[0]==="verse"?t.verseId=Number(e[1]):e.length>=4&&e[0]==="book"&&(t.bookId=Number(e[1]),e[2]==="chapter"&&(t.chapterId=Number(e[3])),e.length>=6&&e[4]==="verse"&&(t.verseId=Number(e[5]))),t}window.addEventListener("hashchange",()=>ye());async function M(){let e=await L();m.innerHTML="",e.forEach(t=>{let r=document.createElement("option");r.value=t.id,r.textContent=t.name,m.appendChild(r)}),e[0]&&await I(e[0].id)}m.addEventListener("change",async()=>{let e=Number(m.value);if(!e)return;await I(e);let t=w[0];t&&x(`/chapter/${t.id}`)});async function I(e){let t=await J(e);w=Array.isArray(t)?t:[],y.innerHTML="",w.forEach(r=>{let n=document.createElement("option");n.value=String(r.number),n.textContent=r.number,y.appendChild(n)}),w[0]&&await b(w[0].id)}async function b(e,t={selectVerseId:null,showWholeChapter:!1}){let r=await z(e);if(h=Array.isArray(r)?r:[],g.innerHTML="",h.forEach(n=>{let o=document.createElement("option");o.value=String(n.number),o.textContent=n.number,g.appendChild(o)}),t&&t.selectVerseId){let n=h.find(o=>Number(o.id)===Number(t.selectVerseId));if(n){g.value=String(n.number),await B(Number(n.id));return}}if(t&&t.selectVerseNumber){let n=h.find(o=>Number(o.number)===Number(t.selectVerseNumber));if(n){g.value=String(n.number),await B(Number(n.id));return}}if(t.showWholeChapter){H.innerHTML="";let n=document.createElement("div");n.className="chapter-view",H.appendChild(n);let o=r.map(a=>{let i=document.createElement("div");i.className="verse-block";let s=document.createElement("h4"),c=document.createElement("a");c.href=`#/verse/${a.id}`,c.textContent=`Verse ${a.number}`,c.addEventListener("click",async d=>{d.preventDefault(),await b(e,{selectVerseId:a.id,showWholeChapter:!1}),x(`/verse/${a.id}`)}),s.appendChild(c),i.appendChild(s);let l=document.createElement("div");return l.id=`verse-${a.id}`,i.appendChild(l),n.appendChild(i),{id:a.id,wrapper:l}});await Promise.all(o.map(async a=>{let i=await T(a.id),s=document.createElement("ul");s.className="verse-words",i.forEach(c=>{let l=document.createElement("li"),d=ge(c);l.appendChild(d),s.appendChild(l)}),a.wrapper.appendChild(s);try{await re(i.map(c=>c.strong).filter(Boolean))}catch{}}));return}h[0]&&await B(h[0].id)}function ge(e){let t=e.verse_original||"",r=e.verse_translation||"",n=document.createElement("div");n.className="word-box word-main selectable",n.tabIndex=0,n.setAttribute("role","button"),n.setAttribute("draggable","true"),n.setAttribute("aria-label",(r||t||e.strong)+" \u2014 strong "+(e.strong||"")),n.dataset.strong=e.strong||"",n.dataset.allOriginals=JSON.stringify(Array.isArray(e.all_originals)?e.all_originals:[]),n.dataset.allTranslations=JSON.stringify(Array.isArray(e.all_translations)?e.all_translations:[]);let o=ke(t||"");if(o){let s=document.createElement("div");s.className="word-translit",s.textContent=o,n.appendChild(s)}let a=document.createElement("div");a.className="word-english",a.textContent=r||"",n.appendChild(a);let i=document.createElement("div");return i.className="word-original",i.textContent=t||(r?"":e.strong||"(no text)"),n.appendChild(i),n.addEventListener("dragstart",s=>{try{s.dataTransfer.setData("text/plain",e.strong||"")}catch{}n.dataset.draggedAt=String(Date.now()),n.classList.add("dragging")}),n.addEventListener("dragend",()=>{setTimeout(()=>{n.classList.remove("dragging"),n.dataset.draggedAt=""},50)}),n.addEventListener("keydown",s=>{if(s.key==="Enter")window.open("strong.html#"+encodeURIComponent(e.strong),"_blank");else if(s.key===" "){s.preventDefault(),n.classList.toggle("selected");let c=Array.from(document.querySelectorAll(".word-box.selected"));c.length===1?document.getElementById("src").value=c[0].dataset.strong||"":c.length===2&&(document.getElementById("src").value=c[0].dataset.strong||"",document.getElementById("tgt").value=c[1].dataset.strong||"")}}),n.addEventListener("click",()=>{let s=Number(n.dataset.draggedAt||0);s&&Date.now()-s<300||window.open("strong.html#"+encodeURIComponent(e.strong),"_blank")}),n}async function B(e){let t=await T(e);H.innerHTML="",t.forEach(r=>{let n=document.createElement("li");n.appendChild(ge(r)),H.appendChild(n)});try{await re(t.map(r=>r.strong).filter(Boolean))}catch{}}async function re(e){if(!(!Array.isArray(e)||e.length===0))try{let t=await Y(e),r={};try{r=await Z(e)}catch{r={}}for(let n of e){let o=!!t[n],a=document.querySelectorAll(`.word-box[data-strong="${CSS.escape(n)}"]`),i=r[n]?Number(r[n]):0;a.forEach(s=>{o?s.classList.add("has-relation"):s.classList.remove("has-relation");let c=s.querySelector(".relation-badge");i>0?(c||(c=document.createElement("div"),c.className="relation-badge",s.appendChild(c)),c.textContent=String(i)):c&&c.remove()})}}catch{}}var q=document.getElementById("add-relation-panel"),P=document.getElementById("relations-panel");function we(e){e.preventDefault()}function Ae(e){e.preventDefault();let t=e.dataTransfer.getData("text/plain");if(!t)return;let r=document.getElementById("src"),n=document.getElementById("tgt"),o=!1;try{let a=document.elementFromPoint(e.clientX,e.clientY),i=a&&a.closest?a.closest("input"):null;i===n?(n.value=t,o=!0):i===r&&(r.value=t,o=!0)}catch{}if(!o){let a=document.activeElement;a===n||a===r?a.value=t:r.value=t}q.classList.add("drop-target"),setTimeout(()=>q.classList.remove("drop-target"),350)}function Re(e){e.preventDefault();let t=e.dataTransfer.getData("text/plain");t&&(document.getElementById("relations-strong").value=t,document.getElementById("showRelations").click(),P.classList.add("drop-target"),setTimeout(()=>P.classList.remove("drop-target"),350))}q.addEventListener("dragover",we);q.addEventListener("drop",Ae);P.addEventListener("dragover",we);P.addEventListener("drop",Re);document.getElementById("showRelations").addEventListener("click",async()=>{let e=document.getElementById("relations-strong").value.trim();if(!e)return;let t=await X(e),r=document.getElementById("relations-list");r.innerHTML="";for(let n of t){let o=document.createElement("li"),a=document.createElement("div"),i=n.source_id,s=n.target_id;try{let[l,d]=await Promise.allSettled([$(n.source_id),$(n.target_id)]);if(l.status==="fulfilled"&&l.value){let u=l.value;i=Array.isArray(u.all_originals)&&u.all_originals[0]||Array.isArray(u.all_translations)&&u.all_translations[0]||n.source_id}if(d.status==="fulfilled"&&d.value){let u=d.value;s=Array.isArray(u.all_originals)&&u.all_originals[0]||Array.isArray(u.all_translations)&&u.all_translations[0]||n.target_id}}catch{}if(a.textContent=`${n.relation_type}: ${i} (${n.source_id}) \u2192 ${s} (${n.target_id})`,o.appendChild(a),n.source_verse_ids&&n.source_verse_ids.length){let l=document.createElement("div");l.style.marginTop=".25rem",n.source_verse_ids.forEach(d=>{let u=document.createElement("button");u.textContent=`(Source: Link) ${d}`,u.style.marginRight="6px",u.addEventListener("click",async()=>{let S=await O(d);if(!S)return;let A=await k(S.chapter_id);A&&(await I(A.book_id),setTimeout(async()=>{let ae=w.find(R=>Number(R.id)===Number(A.id));if(ae){y.value=String(ae.number),await b(A.id);let R=h.find(ve=>Number(ve.id)===Number(S.id));R&&(g.value=String(R.number))}},150))}),l.appendChild(u)}),o.appendChild(l)}let c=document.createElement("button");c.textContent="Remove",c.style.marginLeft="8px",c.addEventListener("click",async()=>{if(confirm("Remove this relation group? This will delete matching relations individually."))try{let d=(await W(n.source_id)).filter(u=>u.source_id===n.source_id&&u.target_id===n.target_id&&u.relation_type===n.relation_type);for(let u of d)await K(u.id);document.getElementById("showRelations").click(),await oe()}catch(l){alert("Failed to remove relation(s): "+String(l))}}),o.appendChild(c),r.appendChild(o)}});var De=document.getElementById("add-relation-panel"),N=de(De);function je(e){let t=e.target.closest?e.target.closest(".word-main"):e.target;if(t){let r=[],n=[];try{r=JSON.parse(t.dataset.allOriginals||"[]")}catch{}try{n=JSON.parse(t.dataset.allTranslations||"[]")}catch{}let o=ue(ne(n,10),ne(r,10),V);N.show(o)}}function Te(e){let t=e.target,r=e.relatedTarget,n=t&&t.closest?t.closest(".word-main"):null,o=r&&r.closest?r.closest(".word-main"):null;n&&n===o||n&&N.hide()}document.body.addEventListener("mouseover",je);document.body.addEventListener("mouseout",Te);pe(document.getElementById("shortcutInfo"),N,fe);document.body.addEventListener("focusin",e=>{let t=e.target;if(t&&t.classList&&t.classList.contains("word-main")){let r=[],n=[];try{r=JSON.parse(t.dataset.allOriginals||"[]")}catch{}try{n=JSON.parse(t.dataset.allTranslations||"[]")}catch{}let o=n.length?"<ul>"+n.map(i=>`<li>${V(i)}</li>`).join("")+"</ul>":"<div>-</div>",a=r.length?"<ul>"+r.map(i=>`<li>${V(i)}</li>`).join("")+"</ul>":"<div>-</div>";N.show(`<div class="tooltip-grid"><div class="tooltip-col"><h4>Translations</h4>${o}</div><div class="tooltip-col"><h4>Originals</h4>${a}</div></div>`)}});document.body.addEventListener("focusout",e=>{let t=e.target;t&&t.classList&&t.classList.contains("word-main")&&N.hide()});y.addEventListener("change",async()=>{let e=Number(y.value),t=w.find(r=>Number(r.number)===e);t&&(await b(t.id,{selectVerseId:null,showWholeChapter:!0}),x(`/chapter/${t.id}`))});async function Oe(){let e=Number(y.value)||0,t=w.find(r=>Number(r.number)===e+1);t&&(y.value=String(t.number),await b(t.id,{selectVerseId:null,showWholeChapter:!0}),x(`/chapter/${t.id}`))}async function $e(){let e=Number(g.value)||0,t=h.find(r=>Number(r.number)===e+1);t&&(g.value=String(t.number),await B(t.id),x(`/verse/${t.id}`))}me&&me.addEventListener("click",async e=>{e.preventDefault(),await Oe()});he&&he.addEventListener("click",async e=>{e.preventDefault(),await $e()});g.addEventListener("change",async()=>{let e=Number(g.value),t=h.find(r=>Number(r.number)===e);t&&(await B(t.id),x(`/verse/${t.id}`))});document.getElementById("addRel").addEventListener("click",async()=>{let e=document.getElementById("src"),t=document.getElementById("tgt"),r=document.getElementById("type"),n=e&&e.value?e.value:"",o=t&&t.value?t.value:"",a=r&&r.value?r.value.trim():"";if(!n||!o){f.textContent="Please select source and target words";return}if(!a){f.textContent="Please enter or select a relation type";return}let i={source_id:n,target_id:o,relation_type:a},s=Number(g.value||0),c=h.find(l=>Number(l.number)===s);c&&(i.source_verse_id=c.id);try{let l=await G(i);f.textContent="Relation added: "+JSON.stringify(l),await oe(),document.querySelectorAll(".word-box.selected").forEach(d=>d.classList.remove("selected")),e.value="",t.value=""}catch(l){f.textContent="Error adding relation: "+String(l)}});document.getElementById("exportRelations").addEventListener("click",async()=>{try{let e=await ee(),t=new Blob([e],{type:"application/json"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="parallelismus-relations.json",n.click(),URL.revokeObjectURL(r),f.textContent="Relations exported."}catch(e){f.textContent="Export failed: "+String(e)}});document.getElementById("importRelations").addEventListener("click",()=>{let e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",async()=>{let t=e.files[0];if(t)try{let r=await t.text(),n=await te(r);f.textContent=`Imported ${n} relations. Reloading\u2026`,await oe();let o=Array.from(document.querySelectorAll(".word-box[data-strong]")).map(a=>a.dataset.strong).filter(Boolean);await re([...new Set(o)])}catch(r){f.textContent="Import failed: "+String(r)}}),e.click()});async function ye(){let e=Ne();if(!e.chapterId&&!e.verseId){await M();return}if(e.chapterId){let t=await k(e.chapterId);if(!t){await M();return}let r=await L();m.innerHTML="",r.forEach(o=>{let a=document.createElement("option");a.value=o.id,a.textContent=o.name,m.appendChild(a)}),m.value=String(t.book_id),await I(t.book_id);let n=w.find(o=>Number(o.id)===Number(e.chapterId));n&&(y.value=String(n.number),await b(n.id,{selectVerseId:e.verseId||null,showWholeChapter:!e.verseId}));return}if(e.verseId){let t=await O(e.verseId);if(!t){await M();return}let r=await k(t.chapter_id);if(!r){await M();return}let n=await L();m.innerHTML="",n.forEach(a=>{let i=document.createElement("option");i.value=a.id,i.textContent=a.name,m.appendChild(i)}),m.value=String(r.book_id),await I(r.book_id);let o=w.find(a=>Number(a.id)===Number(r.id));o&&(y.value=String(o.number),await b(r.id,{selectVerseId:e.verseId,showWholeChapter:!1}));return}}async function oe(){let e=await Q(),t=document.getElementById("relation-types");t.innerHTML=e.map(r=>`<option value="${r}"></option>`).join("")}window.addEventListener("error",e=>{console.error("Unhandled error",e.error||e.message,e),f&&(f.textContent="Runtime error: "+String(e.error||e.message))});window.addEventListener("unhandledrejection",e=>{console.error("Unhandled rejection",e.reason),f&&(f.textContent="Unhandled promise rejection: "+String(e.reason))});var Ye={};})();
