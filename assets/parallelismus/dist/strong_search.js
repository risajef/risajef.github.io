(()=>{var x="parallelismus";var v=(function(){try{if(window.__PARALLELISMUS_BASE__)return window.__PARALLELISMUS_BASE__;if(document.currentScript&&document.currentScript.src)return new URL("./",document.currentScript.src).href}catch{}return""})(),y=v+"data/bible.json",c=null,p=null;function S(){return new Promise((r,t)=>{let i=indexedDB.open(x,1);i.onupgradeneeded=o=>{let e=o.target.result;if(e.objectStoreNames.contains("books")||e.createObjectStore("books",{keyPath:"id"}),e.objectStoreNames.contains("chapters")||e.createObjectStore("chapters",{keyPath:"id"}).createIndex("book_id","book_id",{unique:!1}),e.objectStoreNames.contains("verses")||e.createObjectStore("verses",{keyPath:"id"}).createIndex("chapter_id","chapter_id",{unique:!1}),!e.objectStoreNames.contains("verseWords")){let n=e.createObjectStore("verseWords",{keyPath:"id"});n.createIndex("verse_id","verse_id",{unique:!1}),n.createIndex("word_id","word_id",{unique:!1})}if(e.objectStoreNames.contains("words")||e.createObjectStore("words",{keyPath:"strong"}),!e.objectStoreNames.contains("relations")){let n=e.createObjectStore("relations",{keyPath:"id",autoIncrement:!0});n.createIndex("source_id","source_id",{unique:!1}),n.createIndex("target_id","target_id",{unique:!1})}},i.onsuccess=()=>r(i.result),i.onerror=()=>t(i.error)})}function f(r,t,i){return new Promise((o,e)=>{let n=r.transaction(t,"readwrite"),s=n.objectStore(t);for(let a of i)s.put(a);n.oncomplete=()=>o(),n.onerror=()=>e(n.error)})}function E(r,t){return new Promise((i,o)=>{let n=r.transaction(t,"readonly").objectStore(t).count();n.onsuccess=()=>i(n.result),n.onerror=()=>o(n.error)})}async function B(r,t){if(await E(r,"books")>0){t&&t("Database already loaded.");return}t&&t("Downloading bible data\u2026");let o=await fetch(y);if(!o.ok)throw new Error(`Failed to fetch ${y}: ${o.status}`);let e=await o.json();t&&t("Loading books\u2026"),await f(r,"books",e.books),t&&t("Loading chapters\u2026"),await f(r,"chapters",e.chapters),t&&t("Loading verses\u2026"),await f(r,"verses",e.verses),t&&t("Loading words\u2026"),await f(r,"words",e.words),t&&t("Loading verse-words (this may take a moment)\u2026");let n=e.verseWords,s=2e4;for(let a=0;a<n.length;a+=s)await f(r,"verseWords",n.slice(a,a+s)),t&&t(`Loading verse-words\u2026 ${Math.min(a+s,n.length)}/${n.length}`);t&&t("Database ready.")}async function _(r){return c||p||(p=(async()=>(c=await S(),await B(c,r),c))(),p)}function D(r){return new Promise((t,i)=>{let e=c.transaction(r,"readonly").objectStore(r).getAll();e.onsuccess=()=>t(e.result),e.onerror=()=>i(e.error)})}async function w(r){let t=(r||"").trim().toLowerCase();if(!t)return[];let i=await D("words"),o=[];for(let e of i){let n=!1;for(let s of e.translation||[])if(s&&s.toLowerCase().includes(t)){n=!0;break}if(!n){for(let s of e.original||[])if(s&&s.toLowerCase().includes(t)){n=!0;break}}n&&o.push({strong:e.strong,original:e.original,translation:e.translation})}return o}var g=document.getElementById("q"),A=document.getElementById("go"),u=document.getElementById("results"),l=document.getElementById("loading-status");(async()=>{try{await _(t=>{l&&(l.textContent=t)}),l&&(l.style.display="none");let r=new URLSearchParams(location.search);r.get("q")&&(g.value=r.get("q"),m())}catch(r){l&&(l.textContent="DB init failed: "+String(r))}})();async function m(){let r=(g.value||"").trim();if(!r){u.innerHTML="<div>Enter a query</div>";return}u.innerHTML="<div>Searching\u2026</div>";try{let t=await w(r);if(!t||!t.length){u.innerHTML="<div>(no results)</div>";return}let i=document.createElement("ul");t.forEach(o=>{let e=document.createElement("li"),n=document.createElement("div");n.style.fontWeight="600",n.textContent=o.strong,e.appendChild(n);let s=document.createElement("div");s.innerHTML=`<strong>Translations:</strong> ${Array.isArray(o.translation)?o.translation.slice(0,6).map(h=>b(h)).join(", "):""}`,e.appendChild(s);let a=document.createElement("div");a.innerHTML=`<strong>Originals:</strong> ${Array.isArray(o.original)?o.original.slice(0,6).map(h=>b(h)).join(", "):""}`,e.appendChild(a);let d=document.createElement("a");d.href="strong.html#"+encodeURIComponent(o.strong),d.textContent="Open details",d.style.marginTop="6px",d.target="_blank",e.appendChild(d),i.appendChild(e)}),u.innerHTML="",u.appendChild(i)}catch(t){u.innerHTML="<div>Error: "+String(t)+"</div>"}}function b(r){return r==null?"":String(r).replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t])}g.addEventListener("keydown",r=>{r.key==="Enter"&&m()});A.addEventListener("click",m);})();
